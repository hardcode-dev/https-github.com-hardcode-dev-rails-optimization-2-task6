# Case-study оптимизации

## Cleanup

Отправной точкой работы над проектом стало задание бюджета на размер сборки JavaScript файлов для главной страницы сайта.
Установка дополнительного плагина `webpack-bundle-analyzer` позволила обнаружить нерациональное использование библиотеки Moment.js, а именно ее загрузки на каждой странице.

В первую очередь были сделаны два скриншота текущего состояния бандла до внесения изменений и после первого подхода, состоящего во временном отключении содержимого файла `proCharts.js` (графики, создаваемые с помощью `Chart.js` часто используют операции с датами и временем для построения координат, т.е. напрямую связаны с `Moment.js`, что так же отражено в зависимостях в файле `yarn.lock` между этими двумя библиотеками):

- `sitespeed-result/Bundle_before_changes.png`
- `sitespeed-result/Bundle_without_Moment.png`

Следующим шагом стало исследование проекта на предмет выявления места, где библиотека `Moment.js` (как зависимость для `Chart.js`) должна по задумке использоваться, чтобы загружать ее только там.

- `app/views/dashboards/pro.html.erb` шаблон использует файл `proCharts`: `<%= javascript_pack_tag "proCharts", defer: true %>`, который мы для проверки гипотезы закомментировали ранее.
- этот шаблон используется `app/controllers/dashboards_controller.rb` для пользователей с ролью `pro` (авторы статей и блогеры) и вызывается переходом по адресу `get "/dashboard/pro" => "dashboards#pro`
- в файле `config/webpack/environment.js` уже используется плагин для Webpack `CommonsChunkPlugin`, который, следуя документации https://webpack.js.org/plugins/commons-chunk-plugin/#passing-the-minchunks-property-a-function, позволяет настроить условие для включения библиотек в бандл `vendor.js`
- добавляем условия исключения Moment и Chart из этой функции настройки плагина и в результате уменьшаем размер бандла: `sitespeed-result/Bundle_after_repack.png`

Бюджет немного пришлось увеличить с 460000 до 468000, чтобы тест sitespeed.io стал выполняться. Очевидно, это связано с добавлением нескольких зависемостей в сборке (см `yarn.lock`)

## Настройка CI

Теперь настроим `CI` `Github Actions` для защиты от регрессии: файл `.github/workflows/sitespeedio.yml` использует сервис `ngrok` и создает публичный адрес для туннеля на локальный компьютер для тестирования укладывания в бюджет по размеру сборки.
